<header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg">
    <div class="container mx-auto flex justify-between items-center py-2">
        <h1 class="text-3xl font-extrabold tracking-tight">MediFácil</h1>
        <nav id="navbar" class="space-x-4">
            <button *ngIf="currentUser" (click)="logout()"
                class="bg-white text-blue-700 font-semibold py-2 px-6 rounded-full shadow-md hover:bg-blue-100 transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-opacity-75">
                Cerrar Sesión
            </button>
        </nav>
    </div>
</header>

<main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Loading Indicator -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 flex flex-col justify-center items-center z-50 transition-opacity duration-300"
        [class.opacity-100]="loading" [class.opacity-0]="!loading" [class.pointer-events-none]="!loading">
        <div class="loader mb-3"></div>
        <p class="ml-3 text-xl font-semibold text-blue-600">Cargando...</p>
    </div>

    <!-- Login/Register Section -->
    <section id="auth-section" class="flex justify-center items-center min-h-[calc(100vh-100px)]" *ngIf="!currentUser">
        <div class="card p-8 sm:p-10 bg-white rounded-2xl shadow-xl w-full max-w-md space-y-7 border border-gray-200">
            <h2 class="text-4xl font-extrabold text-center text-gray-800 mb-6 tracking-tight">Bienvenido a MediFácil</h2>
            
            <!-- Registration Form -->
            <div id="register-form" [class.hidden]="showLoginForm" class="space-y-5">
                <h3 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">Registro</h3>
                <p class="text-gray-600 text-sm mb-4">El registro aquí es solo para demostración. Puedes usar cualquier dato. Si quieres acceder a un rol predefinido, usa el login.</p>
                
                <div>
                    <label for="reg-email" class="block text-gray-700 text-sm font-semibold mb-1">Correo Electrónico:</label>
                    <input type="email" id="reg-email" [(ngModel)]="regEmail" placeholder="tu@ejemplo.com" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                </div>
                <div>
                    <label for="reg-password" class="block text-gray-700 text-sm font-semibold mb-1">Contraseña:</label>
                    <input type="password" id="reg-password" [(ngModel)]="regPassword" placeholder="********" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                </div>
                <div>
                    <label for="reg-name" class="block text-gray-700 text-sm font-semibold mb-1">Nombre Completo:</label>
                    <input type="text" id="reg-name" [(ngModel)]="regName" placeholder="Juan Pérez" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                </div>
                <div>
                    <label for="reg-document" class="block text-gray-700 text-sm font-semibold mb-1">Número de Documento:</label>
                    <input type="text" id="reg-document" [(ngModel)]="regDocument" placeholder="123456789" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                </div>
                <div>
                    <label for="reg-dob" class="block text-gray-700 text-sm font-semibold mb-1">Fecha de Nacimiento:</label>
                    <input type="date" id="reg-dob" [(ngModel)]="regDob" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                </div>
                <div>
                    <label for="reg-contact" class="block text-gray-700 text-sm font-semibold mb-1">Contacto (Teléfono/Celular):</label>
                    <input type="text" id="reg-contact" [(ngModel)]="regContact" placeholder="+57 300 1234567" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                </div>
                <div>
                    <label for="reg-role" class="block text-gray-700 text-sm font-semibold mb-1">Registrarse como:</label>
                    <select id="reg-role" [(ngModel)]="regRole" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                        <option value="patient">Paciente</option>
                        <option value="pharmacist">Farmacéutico</option>
                    </select>
                </div>
                <button (click)="register()" class="btn-primary w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    <span id="register-btn-text">Registrarse</span>
                    <div id="register-spinner" class="loader ml-2 hidden"></div>
                </button>
                <p class="text-center text-gray-600 mt-5 text-sm">¿Ya tienes cuenta? <a href="#" (click)="showLogin()" class="text-blue-600 hover:underline font-semibold">Inicia Sesión aquí</a></p>
            </div>

            <!-- Login Form -->
            <div id="login-form" [class.hidden]="!showLoginForm" class="space-y-5">
                <h3 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">Inicio de Sesión</h3>
                <p class="text-gray-600 text-sm mb-4">Usa las siguientes credenciales para probar:</p>
                <ul class="list-disc list-inside text-gray-700 mb-4 text-sm bg-blue-50 p-3 rounded-lg border border-blue-200">
                    <li>**Paciente:** <code class="font-mono bg-blue-100 p-1 rounded">paciente@demo.com</code> / <code class="font-mono bg-blue-100 p-1 rounded">password123</code></li>
                    <li>**Farmacéutico:** <code class="font-mono bg-blue-100 p-1 rounded">farmaceutico@demo.com</code> / <code class="font-mono bg-blue-100 p-1 rounded">password123</code></li>
                </ul>
                <div>
                    <label for="login-email" class="block text-gray-700 text-sm font-semibold mb-1">Correo Electrónico:</label>
                    <input type="email" id="login-email" [(ngModel)]="loginEmail" placeholder="tu@ejemplo.com" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                </div>
                <div>
                    <label for="login-password" class="block text-gray-700 text-sm font-semibold mb-1">Contraseña:</label>
                    <input type="password" id="login-password" [(ngModel)]="loginPassword" placeholder="********" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                </div>
                <button (click)="login()" class="btn-primary w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    <span id="login-btn-text">Iniciar Sesión</span>
                    <div id="login-spinner" class="loader ml-2 hidden"></div>
                </button>
                <p class="text-center text-gray-600 mt-5 text-sm">¿No tienes cuenta? <a href="#" (click)="showRegister()" class="text-blue-600 hover:underline font-semibold">Regístrate aquí</a></p>
            </div>
            <div id="auth-message" class="text-center text-red-500 font-medium mt-4" [class.hidden]="!authMessage">{{ authMessage }}</div>
        </div>
    </section>

    <!-- Patient Dashboard Section -->
    <section id="patient-dashboard" *ngIf="currentUserRole === 'patient'" class="space-y-8">
        <h2 class="text-4xl font-extrabold text-gray-800 mb-6 tracking-tight">Panel de Paciente</h2>
        <p class="text-xl text-gray-700 mb-8">Bienvenido, <span id="patient-name-display" class="font-bold text-blue-600">{{ currentUser?.name }}</span>! (ID: <span id="patient-id-display" class="text-sm text-gray-500">{{ currentUserId }}</span>)</p>

        <!-- Medicine Consultation -->
        <div class="card p-6 sm:p-8 bg-white rounded-2xl shadow-lg border border-gray-200">
            <h3 class="text-2xl font-bold text-gray-700 mb-5 flex items-center"><i class="fas fa-search mr-3 text-blue-500"></i> Consulta de Medicamentos</h3>
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <input type="text" id="medicine-search-input" [(ngModel)]="medicineSearchInput" placeholder="Buscar por nombre o código..." class="input-field flex-grow border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                <button (click)="searchMedicine()" class="btn-primary flex-shrink-0 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:scale-105">Buscar</button>
            </div>
            <!-- Message for no results -->
            <p class="text-gray-500 text-center py-4" *ngIf="filteredMedicines.length === 0">No hay resultados. Intenta buscar un medicamento.</p>
            <div id="medicine-results" class="space-y-4">
                <!-- Medicine cards will be rendered by *ngFor -->
                <div *ngFor="let med of filteredMedicines" class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                    <h4 class="text-xl font-semibold text-gray-800">{{ med.name }}</h4>
                    <p class="text-gray-600 text-sm">ID: {{ med.id }}</p>
                    <p class="text-gray-700">{{ med.description }}</p>
                    <p class="text-gray-700">Dosis: {{ med.dose }} {{ med.unit }}</p>
                    <p class="text-gray-700">Cantidad Disponible: <span class="{{ med.quantityAvailable > 0 ? 'text-green-600' : 'text-red-600' }} font-bold">{{ med.quantityAvailable }}</span></p>
                    <p class="text-gray-500 text-sm">Vencimiento: {{ med.expiryDate }}</p>
                    <button *ngIf="med.quantityAvailable > 0" (click)="selectMedicine(med.id, med.name)"
                        class="btn-primary mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-6 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Solicitar
                    </button>
                    <p *ngIf="med.quantityAvailable <= 0" class="text-red-600 mt-2 font-medium">No disponible</p>
                </div>
            </div>
        </div>

        <!-- Request/Delivery Section -->
        <div class="card p-6 sm:p-8 bg-white rounded-2xl shadow-lg border border-gray-200">
            <h3 class="text-2xl font-bold text-gray-700 mb-5 flex items-center"><i class="fas fa-truck mr-3 text-blue-500"></i> Solicitud de Entrega / Recogida</h3>
            <div id="request-message" class="mb-4 p-3 rounded-lg font-medium"
                [class.hidden]="!requestMessage"
                [class.bg-green-100]="requestMessage.includes('éxito')" [class.text-green-800]="requestMessage.includes('éxito')"
                [class.bg-red-100]="requestMessage.includes('Error')" [class.text-red-800]="requestMessage.includes('Error')">
                {{ requestMessage }}
            </div>
            <div class="space-y-5">
                <div>
                    <label for="request-medicine-id" class="block text-gray-700 text-sm font-semibold mb-1">ID del Medicamento:</label>
                    <input type="text" id="request-medicine-id" [(ngModel)]="selectedMedicineId" placeholder="ID del medicamento (Ej: med001)" class="input-field border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                </div>
                <div>
                    <label for="request-medicine-name" class="block text-gray-700 text-sm font-semibold mb-1">Nombre del Medicamento:</label>
                    <input type="text" id="request-medicine-name" [(ngModel)]="selectedMedicineName" placeholder="Nombre del medicamento" class="input-field border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed" readonly>
                </div>
                <div>
                    <label for="delivery-type" class="block text-gray-700 text-sm font-semibold mb-1">Tipo de Servicio:</label>
                    <select id="delivery-type" [(ngModel)]="deliveryType" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                        <option value="pickup">Recogida en Farmacia</option>
                        <option value="delivery">Entrega a Domicilio</option>
                    </select>
                </div>
                <div>
                    <label for="document-upload" class="block text-gray-700 text-sm font-semibold mb-1">Subir Receta Médica:</label>
                    <input type="file" id="document-upload" (change)="onFileSelected($event)" accept=".pdf,.doc,.docx,.jpg,.png" class="input-field border-none p-0 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <p class="text-sm text-gray-500 mt-1">Sube tu receta médica (PDF, DOC, DOCX, JPG, PNG). Esto es solo una simulación, no se guardará el archivo real.</p>
                </div>
                <button id="submit-request-btn" (click)="submitRequest()" class="btn-primary w-full flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    <span id="submit-request-btn-text">Solicitar Entrega / Recogida</span>
                    <div id="submit-request-spinner" class="loader ml-2 hidden"></div>
                </button>
                <p id="turns-info" class="text-sm text-gray-600 text-center mt-3 font-semibold"></p>
            </div>
        </div>

        <!-- My Requests Section -->
        <div class="card p-6 sm:p-8 bg-white rounded-2xl shadow-lg border border-gray-200">
            <h3 class="text-2xl font-bold text-gray-700 mb-5 flex items-center"><i class="fas fa-list-alt mr-3 text-blue-500"></i> Mis Solicitudes</h3>
            <!-- Message for no requests -->
            <p class="text-gray-500 text-center py-4" *ngIf="patientRequests.length === 0">No has realizado ninguna solicitud aún.</p>
            <div id="my-requests-list" class="space-y-4">
                <div *ngFor="let req of patientRequests" class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                    <p class="text-lg font-semibold text-gray-800">Medicamento: {{ req.medicineName }}</p>
                    <p class="text-gray-600">Tipo de Servicio: {{ req.deliveryType === 'pickup' ? 'Recogida' : 'Entrega a Domicilio' }}</p>
                    <p class="text-gray-600">Fecha de Solicitud: {{ req.requestDate | date:'short' }}</p>
                    <p class="font-bold">Estado: <span class="{{ getStatusColorClass(req.status) }}">{{ req.status }}</span></p>
                    <p [class.text-green-600]="req.documentUploaded" [class.text-red-500]="!req.documentUploaded">
                        <i class="fas" [class.fa-check-circle]="req.documentUploaded" [class.fa-times-circle]="!req.documentUploaded"></i>
                        {{ req.documentUploaded ? 'Receta adjunta' : 'Receta no adjunta' }}
                    </p>
                    <p *ngIf="req.responseMessage" class="mt-2 text-gray-700">Mensaje del farmacéutico: <span class="font-medium italic">"{{ req.responseMessage }}"</span></p>
                </div>
            </div>
        </div>
    </section>

    <!-- Pharmacist Dashboard Section -->
    <section id="pharmacist-dashboard" *ngIf="currentUserRole === 'pharmacist'" class="space-y-8">
        <h2 class="text-4xl font-extrabold text-gray-800 mb-6 tracking-tight">Panel de Farmacéutico</h2>
        <p class="text-xl text-gray-700 mb-8">Bienvenido, <span id="pharmacist-name-display" class="font-bold text-blue-600">{{ currentUser?.name }}</span>! (ID: <span id="pharmacist-id-display" class="text-sm text-gray-500">{{ currentUserId }}</span>)</p>

        <!-- Inventory Management -->
        <div class="card p-6 sm:p-8 bg-white rounded-2xl shadow-lg border border-gray-200">
            <h3 class="text-2xl font-bold text-gray-700 mb-5 flex items-center"><i class="fas fa-warehouse mr-3 text-blue-500"></i> Gestión de Inventario</h3>
            <div class="space-y-5">
                <div>
                    <label for="add-medicine-name" class="block text-gray-700 text-sm font-semibold mb-1">Nombre del Medicamento:</label>
                    <input type="text" id="add-medicine-name" [(ngModel)]="addMedicineName" placeholder="Nombre" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                </div>
                <div>
                    <label for="add-medicine-quantity" class="block text-gray-700 text-sm font-semibold mb-1">Cantidad:</label>
                    <input type="number" id="add-medicine-quantity" [(ngModel)]="addMedicineQuantity" placeholder="100" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                </div>
                <div>
                    <label for="add-medicine-description" class="block text-gray-700 text-sm font-semibold mb-1">Descripción:</label>
                    <textarea id="add-medicine-description" [(ngModel)]="addMedicineDescription" placeholder="Descripción del medicamento..." rows="2" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400"></textarea>
                </div>
                <div>
                    <label for="add-medicine-dose" class="block text-gray-700 text-sm font-semibold mb-1">Dosis:</label>
                    <input type="text" id="add-medicine-dose" [(ngModel)]="addMedicineDose" placeholder="500mg" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                </div>
                <div>
                    <label for="add-medicine-unit" class="block text-gray-700 text-sm font-semibold mb-1">Unidad:</label>
                    <input type="text" id="add-medicine-unit" [(ngModel)]="addMedicineUnit" placeholder="comprimido" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                </div>
                <div>
                    <label for="add-medicine-expiry" class="block text-gray-700 text-sm font-semibold mb-1">Fecha de Vencimiento:</label>
                    <input type="date" id="add-medicine-expiry" [(ngModel)]="addMedicineExpiry" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                </div>
                <div>
                    <label for="add-medicine-lot" class="block text-gray-700 text-sm font-semibold mb-1">Lote:</label>
                    <input type="text" id="add-medicine-lot" [(ngModel)]="addMedicineLot" placeholder="LOTE-XYZ-001" class="input-field border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400">
                </div>
                <button (click)="addMedicine()" class="btn-primary w-full flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    <span id="add-medicine-btn-text">Agregar Medicamento</span>
                    <div id="add-medicine-spinner" class="loader ml-2 hidden"></div>
                </button>
            </div>
            <h4 class="text-xl font-bold text-gray-700 mt-8 mb-4 border-b pb-2">Medicamentos en Inventario:</h4>
            <!-- Message for no inventory -->
            <p class="text-gray-500 text-center py-4" *ngIf="pharmacistInventory.length === 0">No hay medicamentos en el inventario.</p>
            <div id="inventory-list" class="space-y-4">
                <div *ngFor="let med of pharmacistInventory" class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex-grow">
                        <h4 class="text-xl font-semibold text-gray-800">{{ med.name }}</h4>
                        <p class="text-gray-600 text-sm">ID: {{ med.id }} | Lote: {{ med.lot }} | Vence: {{ med.expiryDate }}</p>
                        <p class="text-gray-700">Stock: <span id="qty-{{ med.id }}" class="font-bold {{ med.quantityAvailable > 0 ? 'text-green-600' : 'text-red-600' }}">{{ med.quantityAvailable }}</span> {{ med.unit }}</p>
                    </div>
                    <div class="flex items-center gap-2 mt-4 md:mt-0">
                        <button class="btn-secondary" (click)="updateInventoryQuantity(med, 'decrease')"><i class="fas fa-minus"></i></button>
                        <input type="number" [(ngModel)]="med.quantityAvailable" class="w-20 text-center input-field p-2 text-sm">
                        <button class="btn-secondary" (click)="updateInventoryQuantity(med, 'increase')"><i class="fas fa-plus"></i></button>
                        <button class="btn-primary" (click)="saveInventoryQuantity(med)"><i class="fas fa-save"></i> Guardar</button>
                        <button class="btn-secondary" (click)="deleteMedicine(med.id)"><i class="fas fa-trash-alt"></i> Eliminar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Requests -->
        <div class="card p-6 sm:p-8 bg-white rounded-2xl shadow-lg border border-gray-200">
            <h3 class="text-2xl font-bold text-gray-700 mb-5 flex items-center"><i class="fas fa-hourglass-half mr-3 text-blue-500"></i> Solicitudes Pendientes</h3>
            <!-- Message for no pending requests -->
            <p class="text-gray-500 text-center py-4" *ngIf="pharmacistPendingRequests.length === 0">No hay solicitudes pendientes.</p>
            <div id="pending-requests-list" class="space-y-4">
                <div *ngFor="let req of pharmacistPendingRequests" class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                    <p class="text-lg font-semibold text-gray-800">Paciente ID: {{ req.patientUid }}</p>
                    <p class="text-gray-600">Nombre del Paciente: {{ req.patientName || 'N/A' }}</p>
                    <p class="text-gray-600">Medicamento: {{ req.medicineName }} (ID: {{ req.medicamentoId }})</p>
                    <p class="text-gray-600">Tipo de Servicio: {{ req.deliveryType === 'pickup' ? 'Recogida' : 'Entrega a Domicilio' }}</p>
                    <p class="text-gray-600">Solicitado: {{ req.requestDate | date:'short' }}</p>
                    <p class="font-bold">Estado: <span class="{{ getStatusColorClass(req.status) }}">{{ req.status }}</span></p>
                    <p [class.text-green-600]="req.documentUploaded" [class.text-red-500]="!req.documentUploaded">
                        <i class="fas" [class.fa-check-circle]="req.documentUploaded" [class.fa-times-circle]="!req.documentUploaded"></i>
                        {{ req.documentUploaded ? 'Receta adjunta (simulada)' : 'Receta no adjunta' }}
                    </p>
                    <div class="mt-4 flex flex-col sm:flex-row gap-2">
                        <input type="text" [(ngModel)]="req.responseMessage" placeholder="Mensaje al paciente (opcional)" class="input-field flex-grow text-sm">
                        <select [(ngModel)]="req.status" class="input-field w-auto sm:w-1/3 text-sm">
                            <option value="Pending">Pendiente</option>
                            <option value="Approved">Aprobado</option>
                            <option value="Rejected">Rechazado</option>
                            <option value="Delivered">Entregado</option>
                        </select>
                        <button class="btn-primary" (click)="updateRequestStatus(req)" [attr.data-req-id]="req.id" [attr.data-patient-uid]="req.patientUid"><i class="fas fa-save mr-1"></i> Actualizar</button>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>
